name: Publish Helm Chart MS Base

on:
  push:
    branches:
      - main
      - rc
      - dev
      - feature/*
    paths:
      - 'ms-base-chart/**'

permissions:
  contents: write # Permite escribir en el repositorio (para GitHub Pages)

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: SemVer 
        id: git-semver
        uses: codedesignplus/semver-git-version@v0.1.10
        with:
          folder: ${{github.workspace}}
          release-branch: 'main'
          release-candidate-branch: 'rc'
          beta-branch: 'dev'
          major-identifier: 'breaking'
          minor-identifier: 'feat' 
          prefix: 'v'
          dir-affected: ./
          previous-version: true
          new-version: true

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0' 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml  # necesario para actualizar la version del chart

      - name: Update Chart Version
        id: update-chart-version
        run: |
          # Get current date in YYYYMMDD format
          current_date=$(date +%Y%m%d)
          # Increment the patch version based on the date
          NEW_VERSION=$(python .github/scripts/increment_patch_version.py my-istio-library/Chart.yaml ${current_date})
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Actualizar Chart.yaml
        run: |
            sed -i "s/^version:.*/version: ${{ steps.git-semver.outputs.new-version-prefix }}/" /${{github.workspace}}/ms-base-chart/Chart.yaml

      - name: Package Helm chart
        run: |
          helm package my-istio-library

      - name: Move chart package to docs directory
        run: mv my-istio-library-*.tgz docs/

      - name: Generate index.yaml
        run: |
          helm repo index docs --url https://${GITHUB_REPOSITORY}.github.io/${{ github.event.repository.name }}/

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs # The folder where your website is